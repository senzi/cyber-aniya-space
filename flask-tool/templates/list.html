{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>é¡¹ç›®åˆ—è¡¨</h2>
  <a href="{{ url_for('add') }}" class="btn btn-primary">æ–°å¢é¡¹ç›®</a>
</div>
<table class="table table-hover align-middle">
  <thead>
    <tr>
      <th>æ ‡é¢˜</th>
      <th>ç®€ä»‹</th>
      <th>æ ‡ç­¾</th>
      <th>çŠ¶æ€</th>
      <th>Repo</th>
      <th>Demo</th>
      <th>og:image</th>
      <th>æ›´æ–°æ—¶é—´</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody id="sortable-list">
    {% for p in projects %}
    <tr data-id="{{ p.id }}">
      <td>{{ p.title }}</td>
      <td class="text-truncate" style="max-width:180px">{{ p.description }}</td>
      <td>
        {% for tag in p.tags %}
          <span class="badge bg-secondary">{{ tag }}</span>
        {% endfor %}
      </td>
      <td>
        <span class="badge bg-info">{{ p.status }}</span>
      </td>
      <td>
        {% if p.repo %}
        <a href="{{ p.repo }}" target="_blank" class="btn btn-sm btn-outline-dark">Repo</a>
        {% endif %}
      </td>
      <td>
        {% if p.demo %}
        <a href="{{ p.demo }}" target="_blank" class="btn btn-sm btn-outline-primary">Demo</a>
        <button class="btn btn-sm btn-outline-success ms-1 ping-btn" data-demo="{{ p.demo }}">Ping</button>
        <span class="ping-status ms-1" id="ping-{{ p.id }}"></span>
        {% endif %}
      </td>
      <td>
        <a href="{{ p.cover_image if p.cover_image else 'https://og-image.vercel.app/' ~ p.title|urlencode ~ '.png?theme=light&md=1&fontSize=100px' }}" target="_blank">
          <img src="{{ p.cover_image if p.cover_image else 'https://og-image.vercel.app/' ~ p.title|urlencode ~ '.png?theme=light&md=1&fontSize=100px' }}" alt="og" class="og-preview" style="max-width:60px;max-height:32px;">
        </a>
      </td>
      <td class="text-nowrap">{{ p.updated_at }}</td>
      <td>
        <a href="{{ url_for('edit', pid=p.id) }}" class="btn btn-sm btn-warning">ç¼–è¾‘</a>
        <form action="{{ url_for('delete', pid=p.id) }}" method="post" style="display:inline" onsubmit="return confirm('ç¡®å®šåˆ é™¤ï¼Ÿ');">
          <button class="btn btn-sm btn-danger" type="submit">åˆ é™¤</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

{% block extra_scripts %}
{% endblock %}

{% block scripts %}
<!-- å¼•å…¥ Sortable.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.querySelectorAll('.ping-btn').forEach(btn => {
  btn.onclick = function() {
    const demo = btn.dataset.demo;
    const statusSpan = btn.parentElement.querySelector('.ping-status');
    statusSpan.textContent = 'æ£€æµ‹ä¸­...';
    fetch('/ping', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: 'demo=' + encodeURIComponent(demo)
    })
    .then(r => r.json())
    .then(data => {
      statusSpan.textContent = data.ok ? 'ğŸŸ¢' : 'ğŸ”´';
    })
    .catch(() => {
      statusSpan.textContent = 'ğŸ”´';
    });
  }
});

// æ‹–æ‹½æ’åºåŠŸèƒ½
const sortable = new Sortable(document.getElementById('sortable-list'), {
  animation: 150,
  handle: 'td', // æ•´è¡Œå¯æ‹–æ‹½
  onEnd: function () {
    const ids = Array.from(document.querySelectorAll('#sortable-list tr')).map(tr => tr.getAttribute('data-id'));
    fetch('/reorder', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ids})
    })
    .then(r => r.json())
    .then(data => {
      if (data.ok) {
        // å¯ç”¨ toast/alert/flash æç¤º
        if (window.bootstrap && bootstrap.Toast) {
          const toast = document.createElement('div');
          toast.className = 'toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3';
          toast.role = 'alert';
          toast.innerHTML = '<div class="d-flex"><div class="toast-body">æ’åºå·²ä¿å­˜</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>';
          document.body.appendChild(toast);
          new bootstrap.Toast(toast, {delay: 1500}).show();
          setTimeout(() => toast.remove(), 2000);
        } else {
          alert('æ’åºå·²ä¿å­˜');
        }
      } else {
        alert('æ’åºä¿å­˜å¤±è´¥');
      }
    })
    .catch(() => {
      alert('æ’åºä¿å­˜å¤±è´¥');
    });
  }
});
  // og:image æ›¿æ¢é€»è¾‘ï¼Œç¡®ä¿ä¸€å®šæ‰§è¡Œ
  function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = (hash << 5) - hash + str.charCodeAt(i);
      hash |= 0;
    }
    return Math.abs(hash);
  }
  function seededRandom(seed) {
    return function() {
      seed = (seed * 48271) % 0x7fffffff;
      return seed / 0x7fffffff;
    };
  }
  function seededShuffle(array, random) {
    const arr = array.slice();
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function generateOgImage(title) {
    const canvas = document.createElement('canvas');
    const width = 1200;
    const height = 630;
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    if (!ctx) return '';

    const seed = hashString(title);
    const random = seededRandom(seed);

    // èƒŒæ™¯æ¸å˜
    const baseColors = ['#ff9a9e', '#fad0c4', '#a1c4fd', '#c2e9fb', '#d4fc79'];
    const colors = seededShuffle(baseColors, random);

    // æ¸å˜è§’åº¦åŸºäº hash éšæœº
    const angle = random() * Math.PI * 2;
    const x1 = width / 2 + Math.cos(angle) * width;
    const y1 = height / 2 + Math.sin(angle) * height;
    const x0 = width / 2 - Math.cos(angle) * width;
    const y0 = height / 2 - Math.sin(angle) * height;

    const gradient = ctx.createLinearGradient(x0, y0, x1, y1);
    colors.forEach((color, idx) => {
      gradient.addColorStop(idx / (colors.length - 1), color);
    });
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);

    // æ–‡å­—
    ctx.fillStyle = '#333333';
    ctx.font = 'bold 90px "LXGW WenKai", sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    // è‡ªåŠ¨æ¢è¡Œ
    const maxWidth = width * 0.8;
    const lines = [];
    let currentLine = '';
    for (const char of title) {
      const testLine = currentLine + char;
      const testWidth = ctx.measureText(testLine).width;
      if (testWidth > maxWidth && currentLine.length > 0) {
        lines.push(currentLine);
        currentLine = char;
      } else {
        currentLine = testLine;
      }
    }
    if (currentLine) lines.push(currentLine);

    const lineHeight = 80;
    const totalHeight = lines.length * lineHeight;
    const startY = (height - totalHeight) / 2 + lineHeight / 2;

    lines.forEach(function(line, index) {
      ctx.fillText(line, width / 2, startY + index * lineHeight);
    });

    return canvas.toDataURL('image/png');
  }

  document.querySelectorAll('.og-preview').forEach(function(img) {
    // æ‰¾åˆ°å¤–å±‚ a æ ‡ç­¾
    const a = img.closest('a');
    if (a && a.href && a.href.includes('og-image.vercel.app')) {
      // ä»åŒä¸€è¡Œç¬¬ä¸€ä¸ª td è·å– title
      let title = '';
      const tr = img.closest('tr');
      if (tr) {
        const td = tr.querySelector('td');
        if (td) title = td.textContent.trim();
      }
      if (title) {
        img.src = generateOgImage(title);
        a.href = img.src;
      }
    }
  });
</script>
{% endblock %}
